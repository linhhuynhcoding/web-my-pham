// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: load_cart_page.sql

package repository

import (
	"context"

	"github.com/jackc/pgx/v5/pgtype"
)

const addCartItem = `-- name: AddCartItem :one
WITH user_cart AS (
    SELECT carts.id FROM carts WHERE user_id = $3
),
product_price AS (
    SELECT price FROM products WHERE id = $1
)
INSERT INTO cart_items (cart_id, product_id, quantity, subtotal)
SELECT 
    (SELECT user_cart.id FROM user_cart),
    $1,
    $2::int,
    (SELECT price FROM product_price) * $2::int
ON CONFLICT (cart_id, product_id) DO UPDATE
SET
    quantity = cart_items.quantity + EXCLUDED.quantity,
    subtotal = cart_items.subtotal + EXCLUDED.subtotal
RETURNING id, cart_id, product_id, quantity, subtotal
`

type AddCartItemParams struct {
	ProductID pgtype.Int4 `json:"product_id"`
	Quantity  int32       `json:"quantity"`
	UserID    pgtype.Int4 `json:"user_id"`
}

func (q *Queries) AddCartItem(ctx context.Context, arg AddCartItemParams) (CartItem, error) {
	row := q.db.QueryRow(ctx, addCartItem, arg.ProductID, arg.Quantity, arg.UserID)
	var i CartItem
	err := row.Scan(
		&i.ID,
		&i.CartID,
		&i.ProductID,
		&i.Quantity,
		&i.Subtotal,
	)
	return i, err
}

const deleteCartItem = `-- name: DeleteCartItem :exec
DELETE FROM cart_items
WHERE id = $1
`

func (q *Queries) DeleteCartItem(ctx context.Context, id int32) error {
	_, err := q.db.Exec(ctx, deleteCartItem, id)
	return err
}

const getCartByUserId = `-- name: GetCartByUserId :many
SELECT
    ci.id AS cart_item_id,
    ci.quantity,
    ci.subtotal,
    p.id AS product_id,
    p.name AS product_name,
    p.price AS product_price,
    p.image_url AS product_image_url,
    (SELECT SUM(subtotal)::int FROM cart_items WHERE cart_id = c.id) AS total_price
FROM
    carts c
JOIN
    cart_items ci ON c.id = ci.cart_id
JOIN
    products p ON ci.product_id = p.id
WHERE
    c.user_id = $1
`

type GetCartByUserIdRow struct {
	CartItemID      int32          `json:"cart_item_id"`
	Quantity        pgtype.Int4    `json:"quantity"`
	Subtotal        pgtype.Numeric `json:"subtotal"`
	ProductID       int32          `json:"product_id"`
	ProductName     string         `json:"product_name"`
	ProductPrice    pgtype.Numeric `json:"product_price"`
	ProductImageUrl string         `json:"product_image_url"`
	TotalPrice      int32          `json:"total_price"`
}

func (q *Queries) GetCartByUserId(ctx context.Context, userID pgtype.Int4) ([]GetCartByUserIdRow, error) {
	rows, err := q.db.Query(ctx, getCartByUserId, userID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	items := []GetCartByUserIdRow{}
	for rows.Next() {
		var i GetCartByUserIdRow
		if err := rows.Scan(
			&i.CartItemID,
			&i.Quantity,
			&i.Subtotal,
			&i.ProductID,
			&i.ProductName,
			&i.ProductPrice,
			&i.ProductImageUrl,
			&i.TotalPrice,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const isCartItemOwner = `-- name: IsCartItemOwner :one
SELECT EXISTS (
    SELECT 1
    FROM cart_items ci
    JOIN carts c ON ci.cart_id = c.id
    WHERE ci.id = $1 AND c.user_id = $2
)
`

type IsCartItemOwnerParams struct {
	CartItemID int32       `json:"cart_item_id"`
	UserID     pgtype.Int4 `json:"user_id"`
}

func (q *Queries) IsCartItemOwner(ctx context.Context, arg IsCartItemOwnerParams) (bool, error) {
	row := q.db.QueryRow(ctx, isCartItemOwner, arg.CartItemID, arg.UserID)
	var exists bool
	err := row.Scan(&exists)
	return exists, err
}

const updateCartItem = `-- name: UpdateCartItem :one
UPDATE cart_items
SET
    quantity = $1::int,
    subtotal = (SELECT price FROM products WHERE products.id = cart_items.product_id) * $1::int
WHERE
    cart_items.id = $2
RETURNING id, cart_id, product_id, quantity, subtotal
`

type UpdateCartItemParams struct {
	Quantity int32 `json:"quantity"`
	ID       int32 `json:"id"`
}

func (q *Queries) UpdateCartItem(ctx context.Context, arg UpdateCartItemParams) (CartItem, error) {
	row := q.db.QueryRow(ctx, updateCartItem, arg.Quantity, arg.ID)
	var i CartItem
	err := row.Scan(
		&i.ID,
		&i.CartID,
		&i.ProductID,
		&i.Quantity,
		&i.Subtotal,
	)
	return i, err
}
